{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <h2>Profile of {{ profile_user.username }}</h2>
        <div class="card">
            <div class="card-body">
                {% if profile_user.profile_picture %}
                    <img src="{{ profile_user.profile_picture.url }}" class="img-thumbnail mb-3" width="150">
                {% endif %}
                <p><strong>Username:</strong> {{ profile_user.username }}</p>
                <p><strong>Email:</strong> {{ profile_user.email }}</p>
                <p><strong>Bio:</strong> {{ profile_user.bio }}</p>
                <a href="{% url 'messaging:new_conversation' profile_user.id %}"
                   class="btn btn-primary position-relative"
                   id="message-btn">
                    <i class="bi bi-envelope"></i> Написать
                    {% if unread_count %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ unread_count }}
                    </span>
                    {% endif %}
                </a>

                {% if user == profile_user %}
                    <a href="{% url 'accounts:profile_edit' %}" class="btn btn-primary">Edit Profile</a>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                {% if user.is_authenticated and user != profile_user %}
                <div class="d-flex justify-content-around">
                    <a href="{% url 'accounts:subscribers_list' profile_user.username %}"
                       class="text-decoration-none text-center">
                        <h5 id="subscribers-count">{{ profile_user.subscribers_count }}</h5>
                        <small class="text-muted">Subscribers</small>
                    </a>
                    <a href="{% url 'accounts:subscriptions_list' profile_user.username %}"
                       class="text-decoration-none text-center">
                        <h5>{{ profile_user.subscriptions_count }}</h5>
                        <small class="text-muted">Subscriptions</small>
                    </a>
                </div>

                <div class="mt-3 text-center" id="subscription-section">
                    <button class="btn {% if is_subscribed %}btn-outline-danger{% else %}btn-primary{% endif %}"
                            id="subscribe-btn"
                            data-user="{{ profile_user.username }}"
                            data-subscribed="{{ is_subscribed|yesno:'true,false' }}">
                        {% if is_subscribed %}Unsubscribe{% else %}Subscribe{% endif %}
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <h3 class="mt-4">Posts by {{ profile_user.username }}</h3>
        {% for post in profile_user.posts.all %}
            <div class="card mb-3">
                <div class="card-body">
                    <p>{{ post.text }}</p>
                    {% if post.image %}
                        <img src="{{ post.image.url }}" class="img-fluid mb-3">
                    {% endif %}
                    <small class="text-muted">{{ post.created_at|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        {% empty %}
            <p>No posts yet.</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('subscribe-btn');
    if (btn) {
        btn.addEventListener('click', function() {
            const username = this.dataset.user;
            const isSubscribed = this.dataset.subscribed === 'true';

            fetch(`/accounts/profile/${username}/subscribe/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data.new_status !== undefined) {
                    const subscribersCount = document.getElementById('subscribers-count');
                    if (subscribersCount) {
                        subscribersCount.textContent = data.subscribers_count;
                    }

                    btn.classList.toggle('btn-primary', !data.new_status);
                    btn.classList.toggle('btn-outline-danger', data.new_status);
                    btn.textContent = data.new_status ? 'Unsubscribe' : 'Subscribe';
                    btn.dataset.subscribed = data.new_status.toString();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating subscription. Please try again.');
            });
        });
    }
});
// В шаблоне профиля
document.getElementById('message-btn').addEventListener('click', function(e) {
    e.preventDefault();
    fetch(`/messages/api/can-message/{{ profile_user.id }}/`)
        .then(response => response.json())
        .then(data => {
            if (data.can_message) {
                window.location.href = this.href;
            } else {
                alert(data.message);
            }
        });
});
</script>
{% endblock %}